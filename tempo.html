<!DOCTYPE html>
<html>
<head>
	<title>Tempo</title>

	<!-- css -->
	<link href='css/tempo.css' rel='stylesheet' type='text/css'>

	
	<link href='https://fonts.googleapis.com/css?family=Lato:400,300,700' rel='stylesheet' type='text/css'>
	<link href='https://fonts.googleapis.com/css?family=Anonymous+Pro:400,700' rel='stylesheet' type='text/css'>
	
	<link href="lib/jquery-ui.css" rel="stylesheet" type="text/css">

	<script src="lib/d3.min.js" charset="utf-8"></script>
	<script src="lib/jquery.min.js"></script>
	<script src="lib/jquery-ui.js"></script>

	<!-- local libraries -->
	<script src='lib/papaparse.min.js' type='text/javascript'></script>
	<script src='lib/sylvester.js' type='text/javascript'></script>
	<script src='lib/glUtils.js' type='text/javascript'></script>

	<!-- common ui components -->
	<script src="src/listselection.js" type="text/javascript"></script>

	<!-- sources -->
	<script src="src/ecodata.js" type="text/javascript"></script>
	<script src="src/timeseries.js" type="text/javascript"></script>
	<script src="src/slider.js" type="text/javascript"></script>
	<script src="src/tempo.js" type="text/javascript"></script>
	<script src="src/tempo_column.js" type="text/javascript"></script>
	<script src="src/tempo_scatter.js" type="text/javascript"></script>

	<script src="src/ui_utils.js" type="text/javascript"></script>

	<style>
		body {
			font-family: 'Lato', 'Helvetica', sans-serif;
			font-weight: 300;
			font-size: 11px;
			margin: 0px 0px;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			cursor: default;
		}
		.slider {
			font-size: 10px;
			padding-left: 10px;
			width: 50px;
			height: 6px;
			display: inline-block;
		}
		div.appTitle {
			font-size: 17px;
			font-weight: 400;
			color: white;
			padding: 5px 15px;
			background-color: #4e4e4e;
		}

		div.visSpace {
			height: 700px;
			margin: 5px 5px;
		}

		#visSVG {
			/* border: 1px dashed #cccccc; */
		}

		#visCanvas {
			position: absolute;
			top: 0px;
			left: 0px;
			z-index: 100;
			pointer-events: none;
		}

		#interactSVG {
			position: absolute;
			top: 0px; left: 0px;
			z-index: 200;
			pointer-events: none;
		}

		.rangeSlider {
			stroke: none;
			fill: rgba(179, 217, 255, 0.85);
		}

	</style>
</head>
<body>
	<!-- app title -->
	<div class="appTitle" width="100%">
		<b>Tempo</b> - Visualization of (many) time series
	</div>

	<!-- upper div -->
	<div width="100%" style="padding: 5px 5px">
		<div style="display: inline-block">
			<div style="display: inline-block">
				<input id="checkShowPoints" type="checkbox" onclick="scatterOptions()">Show points |
			</div>
			&nbsp;size&nbsp;&nbsp;<div class="slider" id="sliderPointSize"></div>
			
			&nbsp;opacity&nbsp;&nbsp;<div class="slider" id="sliderPointOpacity"></div>
		</div>
		
		<div style="display: inline-block">
			<div style="display: inline-block">
				<input id="checkShowLines" type="checkbox" onclick="scatterOptions()">Show lines |
			</div>
			&nbsp;width&nbsp;&nbsp;<div id="sliderLineWidth" class="slider"></div>			
		</div>
	</div>

	<!-- visualization space -->
	<div class="visSpace" width="100%">
		<svg id="visSVG" width="100%" height="100%"></svg>
		<canvas id="visCanvas"></canvas>
		<svg id="interactSVG" width="0" height="0"></svg>
	</div>

	<!-- scatterplot points shader -->
	<script id="shader-vs-points" type="x-shader/x-vertex">
		precision mediump float;
		attribute vec2 aVertexPosition;

		uniform mat4 uMVMatrix;
		uniform mat4 uPMatrix;

		uniform vec2 rangeMin;
		uniform vec2 rangeLen;
		uniform vec2 domainMin;
		uniform vec2 domainLen;
		uniform float pointSize;
		    
		void main(void) 
		{
			vec2 p = ((aVertexPosition - domainMin) / domainLen);
			p.y = 1.0 - p.y;
			gl_Position = uPMatrix * uMVMatrix * vec4(p * rangeLen + rangeMin, 0.0, 1.0);
			
			// the size of the point
			gl_PointSize = pointSize;
		}

	</script>

	<script id="shader-fs-points" type="x-shader/x-fragment">
		precision mediump float;
		uniform float pointOpacity;
		
		void main() 
		{
			float dist = distance( gl_PointCoord, vec2(0.5) );
			float alpha = 1.0 - smoothstep(0.45,0.5,dist);
			gl_FragColor = vec4(0, 0, 0, alpha * pointOpacity);
		}
	</script>


	<!-- connected scatterplot shader -->
	<script id="shader-vs-lines" type="x-shader/x-vertex">
		attribute vec2 aVertexPosition;
		attribute vec4 aVertexColor;   
		uniform mat4 uMVMatrix;
		uniform mat4 uPMatrix;
		uniform vec2 rangeMin;
		uniform vec2 rangeLen;
		uniform vec2 domainMin;
		uniform vec2 domainLen;
		uniform bool singleColor;

		// color
		varying lowp vec4 vColor;
				    
		void main(void) {
			vec2 p = ((aVertexPosition - domainMin) / domainLen);
			p.y = 1.0 - p.y;
			gl_Position = uPMatrix * uMVMatrix * vec4(p * rangeLen + rangeMin, 0.0, 1.0);
			if (singleColor) {
				vColor = vec4(1.0, 0.678, 0.2, 0.85);
			}
			else
			{
				vColor = vec4(vec3(aVertexColor), aVertexColor.a * 0.75);
			}
		}
	</script>

	<script id="shader-fs-lines" type="x-shader/x-fragment">
		varying lowp vec4 vColor;
		void main(void) {
			gl_FragColor = vColor;
		}
	</script>


	</script>


	<script type="text/javascript">
		var tempo = null;
		var TIMESERIES_DATA = [
			'data/indices_mid-day_avg_prep_02-21-2016g_flagExcluded.csv',
			'data/EcoSpec_Summer_2015_GPP_Reco_data_new_DOY-shifted.csv',
			'data/Decagon_NDVI_&_PRI_02-27-2017_30min.csv'
		];
		
		// the data, visualization object (tempo), and gl context
		var theData = new EcoTimeseries(TIMESERIES_DATA, dataReady);
		var tempo = null;
		var gl = null;

		// states
		var shiftKey = false;

		function scatterOptions()
		{
			SHOW_SCATTER_POINTS = d3.select("#checkShowPoints").node().checked;
			SHOW_SCATTER_LINES = d3.select("#checkShowLines").node().checked;
			tempo.renderGL();
		}

		function resizeWindow()
		{
			// maximize div.visSpace
			var visSpace = d3.select('div.visSpace');
			var visSpaceBounds = visSpace.node().getBoundingClientRect();
			visSpace.style("height", (window.innerHeight-visSpaceBounds.top-10) + 'px');

			var visSVG = document.getElementById('visSVG');
			var bounding = visSVG.getBoundingClientRect();
			var w = bounding.right-bounding.left;
			var h = bounding.bottom-bounding.top;

			var canvasW = w;
			var canvasH = h;
			if (window.devicePixelRatio) {
				canvasW *= window.devicePixelRatio;
				canvasH *= window.devicePixelRatio;
			}

			// position the canvas and interaction SVG accordingly
			var canvas = d3.select("#visCanvas")
				.style("top", bounding.top + "px").style("left", bounding.left + "px")
				.attr("width", canvasW)
				.attr("height", canvasH)
				.style("width", w + "px")
				.style("height", h + "px");

			// position the interaction SVG on top of the canvas
			var interactSVG = d3.select("#interactSVG")
				.style("top", bounding.top + "px").style("left", bounding.left + "px")
				.attr("width", w)
				.attr("height", h);

			// update tempo
			if (tempo) {
				tempo.resizeWindow();
				tempo.renderGL();
			}
		}
		window.onresize = resizeWindow;

		function initUI()
		{
			resizeWindow();
			d3.select("#checkShowPoints").node().checked = SHOW_SCATTER_POINTS;
			d3.select("#checkShowLines").node().checked = SHOW_SCATTER_LINES;
	
			d3.select('body')
				.on("keydown", function() {
					if (event.keyCode == 16) {
						shiftKey = true;
					}
				}).on("keyup", function() {
					if (event.keyCode == 16) {
						shiftKey = false;
					}
				});

			$('#sliderPointOpacity').slider({
				range: false,
				min: 0.0, max: 1.0,
				value: POINT_OPACITY,
				step: 0.05/8,
				slide: function( event, ui ) {
					POINT_OPACITY = ui.value;
					tempo.renderGL();
				}
			});

			$('#sliderPointSize').slider({
				range: false,
				min: 1, max: 30,
				value: POINT_SIZE,
				step: 1,
				slide: function( event, ui ) {
					POINT_SIZE = ui.value;
					tempo.renderGL();
				}
			});

			$('#sliderLineWidth').slider({
				range: false,
				min: 1.0, max: 7.0,
				value: LINE_WIDTH,
				step: 0.05,
				slide: function( event, ui ) {
					LINE_WIDTH = ui.value;
					tempo.renderGL();
				}
			});

		}

		// fire up things
		function dataReady() 
		{
			// get gl context
			gl = d3.select("#visCanvas").node().getContext("webgl");

			// initialize UI
			initUI();

			// initialize the vis
			tempo = new Tempo();


		}
		
	</script>
</body>
</html>
